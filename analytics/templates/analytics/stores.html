{% extends 'analytics/base.html' %}
{% block title %}Stores{% endblock %}
{% block content %}
<h1>Stores Page</h1>
<div class="filters">
    <label for="store-select">Selecciona una tienda:</label>
    <select id="store-select">
        {% for tienda in tiendas %}
        <option value="{{ tienda }}">{{ tienda }}</option>
        {% endfor %}
    </select>
    
    <label for="start-date">Fecha de inicio:</label>
    <input type="date" id="start-date" value="{{ fecha_min }}" min="{{ fecha_min }}" max="{{ fecha_max }}">
    
    <label for="end-date">Fecha de fin:</label>
    <input type="date" id="end-date" value="{{ fecha_max }}" min="{{ fecha_min }}" max="{{ fecha_max }}">
    
    <button id="filter-btn">Filtrar</button>
</div>

<div id="data-table">
    <h2>Datos Filtrados</h2>
    <table>
        <thead>
            <tr>
                <th>Tienda</th>
                <th>Cantidad</th>
                <th>Ventas ($)</th>
                <th>Fecha</th>
                <th>Descripción</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="sales-chart">
    <h2>Tendencias de Ventas por Fecha</h2>
    <div id="chart"></div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="/static/js/main.js"></script>

<script >
    document.getElementById("filter-btn").addEventListener("click", function () {
        const store = document.getElementById("store-select").value;
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;
    
        fetch("/filter-data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tienda: store, fecha_inicio: startDate, fecha_fin: endDate }),
        })
            .then((response) => response.json())
            .then((data) => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
    
                // Actualizar tabla
                const tbody = document.querySelector("#data-table tbody");
                tbody.innerHTML = "";
                data.tabla.forEach((row) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${row.Store}</td>
                        <td>${row.SalesQuantity}</td>
                        <td>${row.SalesDollars}</td>
                        <td>${row.SalesDate}</td>
                        <td>${row.Description}</td>
                    `;
                    tbody.appendChild(tr);
                });
    
                // Actualizar gráfica
                const ventasDiarias = data.ventas_diarias;
                const trace = {
                    x: ventasDiarias.map((d) => d.SalesDate),
                    y: ventasDiarias.map((d) => d.SalesDollars),
                    type: "scatter",
                    mode: "lines",
                    line: { color: "#183b61" },
                };
                const layout = { title: "Ventas por Fecha", xaxis: { title: "Fecha" }, yaxis: { title: "Ventas ($)" } };
                Plotly.newPlot("chart", [trace], layout);
            })
            .catch((error) => console.error("Error al filtrar datos:", error));
    });
    
</script>
{% endblock %}
