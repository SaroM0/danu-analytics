{% extends 'analytics/base.html' %}
{% block title %}Stores{% endblock %}
{% block content %}
<h1>Stores Page</h1>

<!-- Filtros -->
<div class="filters">
    <label for="store-select">Selecciona una tienda:</label>
    <select id="store-select">
        <option value="" disabled selected>Selecciona una tienda</option>
        {% for tienda in tiendas %}
        <option value="{{ tienda }}">{{ tienda }}</option>
        {% endfor %}
    </select>

    <label for="start-date">Fecha de inicio:</label>
    <input type="date" id="start-date" value="{{ fecha_min }}" min="{{ fecha_min }}" max="{{ fecha_max }}">

    <label for="end-date">Fecha de fin:</label>
    <input type="date" id="end-date" value="{{ fecha_max }}" min="{{ fecha_min }}" max="{{ fecha_max }}">
    
    <button id="filter-btn">Filtrar</button>
</div>

<!-- Tabla de datos -->
<div id="data-table">
    <h2>Datos Filtrados</h2>
    <table>
        <thead>
            <tr>
                <th>Tienda</th>
                <th>Cantidad</th>
                <th>Ventas (£)</th>
                <th>Fecha</th>
                <th>Descripción</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Gráfica -->
<div id="sales-chart">
    <h2>Tendencias de Ventas por Fecha</h2>
    <div id="chart"></div>
</div>

<!-- Inclusión de Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Agregar evento al botón de filtrar
        document.getElementById("filter-btn").addEventListener("click", function () {
            // Obtener valores de los filtros
            const store = document.getElementById("store-select").value;
            const startDate = document.getElementById("start-date").value;
            const endDate = document.getElementById("end-date").value;

            // Validar los filtros
            if (!store) {
                alert("Por favor, selecciona una tienda.");
                return;
            }
            if (!startDate || !endDate) {
                alert("Por favor, selecciona un rango de fechas válido.");
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                alert("La fecha de inicio no puede ser mayor que la fecha de fin.");
                return;
            }

            // Realizar la solicitud a la API
            fetch("/filter-data", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ tienda: store, fecha_inicio: startDate, fecha_fin: endDate }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then((data) => {
                    // Manejar errores del backend
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    // Actualizar la tabla con los datos filtrados
                    const tbody = document.querySelector("#data-table tbody");
                    tbody.innerHTML = ""; // Limpia la tabla antes de agregar nuevos datos
                    data.tabla.forEach((row) => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${row.Store}</td>
                            <td>${row.SalesQuantity}</td>
                            <td>£${parseFloat(row.SalesDollars).toFixed(2)}</td>
                            <td>${row.SalesDate}</td>
                            <td>${row.Description}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // Actualizar la gráfica con las tendencias de ventas
                    const ventasDiarias = data.ventas_diarias;
                    const trace = {
                        x: ventasDiarias.SalesDate, // Fechas en el eje X
                        y: ventasDiarias.SalesDollars, // Ventas en el eje Y
                        type: "scatter",
                        mode: "lines+markers",
                        line: { color: "#183b61" },
                    };
                    const layout = {
                        title: "Tendencias de Ventas por Fecha",
                        xaxis: { title: "Fecha" },
                        yaxis: { title: "Ventas (£)" },
                    };
                    Plotly.newPlot("chart", [trace], layout);
                })
                .catch((error) => {
                    console.error("Error al filtrar datos:", error);
                    alert("Ocurrió un error al filtrar los datos. Intenta nuevamente.");
                });
        });
    });
</script>

{% endblock %}
